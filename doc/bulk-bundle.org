* Bulk

** create
BulkCreate schema
#+begin_src clojure
(s/defschema NewBulk
   (st/optional-keys
    {:actors          [NewActor]
     :assets          [NewAsset]
     :asset_mappings  [NewAssetMappings]
     :asset_properties[NewAssetProperties]
     :attack_patterns [NewAttackPattern]
     :campaigns       [NewCampaing]
     :coas            [NewCOA]
     :incidents       [NewIncident]
     :indicators      [NewIndicator]
     :investigations  [NewInvestigation]
     :judgements      [NewJudgment]
     :malwares        [NewMalware]
     :relationships   [NewRelationship]
     :casebooks       [NewCasebook]
     :sightings       [NewSighting]
     :target_records  [NewTargetRecord]
     :tools           [NewTool]
     :vulnerabilities [NewVulnerability]
     :weaknesses      [NewWeakness]})
#+end_src

Bulk Create Result is a BulkRefs
#+begin_src clojure
(s/defschema BulkRefs
   (st/optional-keys
    {:tempids         {TransientID ID}
     :actors           [(s/maybe Reference)]
     :assets           [(s/maybe Reference)]
     :asset_mappings   [(s/maybe Reference)]
     :asset_properties [(s/maybe Reference)]
     :attack_patterns  [(s/maybe Reference)]
     :campaigns        [(s/maybe Reference)]
     :coas             [(s/maybe Reference)]
     :incidents        [(s/maybe Reference)]
     :indicators       [(s/maybe Reference)]
     :investigations   [(s/maybe Reference)]
     :judgements       [(s/maybe Reference)]
     :malwares         [(s/maybe Reference)]
     :relationships    [(s/maybe Reference)]
     :casebooks        [(s/maybe Reference)]
     :sightings        [(s/maybe Reference)]
     :target_records   [(s/maybe Reference)]
     :tools            [(s/maybe Reference)]
     :vulnerabilities  [(s/maybe Reference)]
     :weaknesses       [(s/maybe Reference)]}))
#+end_src

example:
#+begin_src clojure
{:incidents
 [{:description
   "## Summary:\n\nOn Monday, June 15th at 3:34am GMT, a host (UUID #dc0415fe-af42-11ea-b3de-0242ac130004) on VLAN 414 established contact with a known Emotet Epoch 2 Command and Control server, triggering an event alarm..",
   :assignees ["saintx"],
   :type "incident",
   :source "Modeling Incidents in CTIM Tutorial",
   :external_ids ["ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f"],
   :short_description
   "Incident Report: 2020-06-15 3:34am (Emotet Botnet Attack)",
   :title "2020-06-15-0334-emotet-botnet-report",
   :incident_time
   {:opened "2020-06-15T03:43:27.368Z",
    :reported "2020-06-15T03:34:36.298Z"},
   :discovery_method "NIDS",
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :categories ["Malicious Code"],
   :status "Containment Achieved",
   :id "transient:ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f",
   :confidence "High"}],
 :sightings
 [{:observables [{:type "ip", :value "98.15.140.226"}],
   :type "sighting",
   :source "Modeling Incidents in CTIM Tutorial",
   :external_ids ["ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d"],
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :id "transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d",
   :count 1,
   :severity "High",
   :tlp "green",
   :timestamp "2020-06-15T03:34:36.298Z",
   :confidence "High",
   :observed_time {:start_time "2020-06-15T03:34:36.298Z"}}],
 :relationships
 [{:type "relationship",
   :source "Modeling Incidents in CTIM Tutorial",
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :source_ref "transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d",
   :target_ref "transient:ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f",
   :relationship_type "member-of",
   :external_ids ["ctim-tutorial-relationship-2c1f3fcaf89d294bf7d038f470f6cb4a81dc1fad6ff5deeed18a41bf6fe14f00"]}
  {:type "relationship",
   :source "Modeling Incidents in CTIM Tutorial",
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :source_ref "transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d",
   :target_ref "https://ex.tld/ctia/indicator/indicator-b790ade3-e45e-48d4-7d06-f0079e6453a0",
   :description "Sighting of host communication with known Emotet Epoch 2 C&C server",
   :relationship_type "sighting-of",
   :external_ids ["ctim-tutorial-relationship-f879541251b139dfbfbed0f5c66a7c6d20246074241fa2f814f0f3eb2250def8"]}]}

   #+end_src

which returns
#+begin_src clojure
{:incidents ["http://localhost:3000/ctia/incident/incident-36c956ee-fde8-4e84-8396-7be9201a9c55"],
 :sightings ["http://localhost:3000/ctia/sighting/sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27"],
 :relationships ["http://localhost:3000/ctia/relationship/relationship-94b5d199-6353-490d-9b75-38bef7f2dc5a" "http://localhost:3000/ctia/relationship/relationship-eca9e3c6-1c32-484e-b8a5-685719142090"],
 :tempids {:transient:ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f "http://localhost:3000/ctia/incident/incident-36c956ee-fde8-4e84-8396-7be9201a9c55", :transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d "http://localhost:3000/ctia/sighting/sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27"}}
#+end_src


** export
Bundle Export enables us to retrieve many entities.

Bulk Export Params
#+begin_src clojure
(s/defschema BulkRefs
   (st/optional-keys
    {:actors           [Reference]
     :assets           [Reference]
     :asset_mappings   [Reference]
     :asset_properties [Reference]
     :attack_patterns  [Reference]
     :campaigns        [Reference]
     :coas             [Reference]
     :feedbacks        [Reference]
     :incidents        [Reference]
     :indicators       [Reference]
     :investigations   [Reference]
     :judgements       [Reference]
     :malwares         [Reference]
     :relationships    [Reference]
     :casebooks        [Reference]
     :sightings        [Reference]
     :target_records   [Reference]
     :tools            [Reference]
     :vulnerabilities  [Reference]
     :weaknesses       [Reference]}))
#+end_src

#+begin_src clojure
(s/defschema BulkRefs
   (st/optional-keys
    {:actors          [Actor]
     :assets          [Asset]
     :asset_mappings  [AssetMappings]
     :asset_properties[AssetProperties]
     :attack_patterns [AttackPattern]
     :campaigns       [Campaing]
     :coas            [COA]
     :incidents       [Incident]
     :indicators      [Indicator]
     :investigations  [Investigation]
     :judgements      [Judgment]
     :malwares        [Malware]
     :relationships   [Relationship]
     :casebooks       [Casebook]
     :sightings       [Sighting]
     :target_records  [TargetRecord]
     :tools           [Tool]
     :vulnerabilities [Vulnerability]
     :weaknesses      [Weakness]})
#+end_src

example:

#+begin_src HTTP
GET /ctia/bulk?incidents=incident-36c956ee-fde8-4e84-8396-7be9201a9c55&sightings=sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27&relationships=relationship-94b5d199-6353-490d-9b75-38bef7f2dc5a√©relationships=relationship-eca9e3c6-1c32-484e-b8a5-685719142090 HTTP/1.1
Host: localhost:3000
Authorization: "Bearer ..."
accept: application/json
#+end_src

returns:
#+begin_src clojure
{:incidents
 [{:id "http://localhost:3000/ctia/incident/incident-36c956ee-fde8-4e84-8396-7be9201a9c55"
   :created "2021-07-05T09:52:39.743Z"
   :owner "gereteo"
   :groups "ireaux"
   :id ""
   :description
   "## Summary:\n\nOn Monday, June 15th at 3:34am GMT, a host (UUID #dc0415fe-af42-11ea-b3de-0242ac130004) on VLAN 414 established contact with a known Emotet Epoch 2 Command and Control server, triggering an event alarm..",
   :assignees ["saintx"],
   :type "incident",
   :source "Modeling Incidents in CTIM Tutorial",
   :external_ids ["ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f"],
   :short_description
   "Incident Report: 2020-06-15 3:34am (Emotet Botnet Attack)",
   :title "2020-06-15-0334-emotet-botnet-report",
   :incident_time
   {:opened "2020-06-15T03:43:27.368Z",
    :reported "2020-06-15T03:34:36.298Z"},
   :discovery_method "NIDS",
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :categories ["Malicious Code"],
   :status "Containment Achieved",
   :id "transient:ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f",
   :confidence "High"}],
 :sightings
 [{:id "http://localhost:3000/ctia/sighting/sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27"
   :created "2021-07-05T09:52:39.743Z"
   :owner "gereteo"
   :groups "ireaux"
   :observables [{:type "ip", :value "98.15.140.226"}],
   :type "sighting",
   :source "Modeling Incidents in CTIM Tutorial",
   :external_ids ["ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d"],
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :id "transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d",
   :count 1,
   :severity "High",
   :tlp "green",
   :timestamp "2020-06-15T03:34:36.298Z",
   :confidence "High",
   :observed_time {:start_time "2020-06-15T03:34:36.298Z"}}],
 [{:id "http://localhost:3000/ctia/relationship/relationship-94b5d199-6353-490d-9b75-38bef7f2dc5a"
   :created "2021-07-05T09:52:39.743Z"
   :owner "gereteo"
   :groups "ireaux"
   :type "relationship",
   :source "Modeling Incidents in CTIM Tutorial",
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :source_ref "transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d",
   :target_ref "transient:ctim-tutorial-incident-c56de1c94c1ce862c4e6d9883393aacc58275c0c4dc4d8b48cc4db692bf11e4f",
   :relationship_type "member-of",
   :external_ids ["ctim-tutorial-relationship-2c1f3fcaf89d294bf7d038f470f6cb4a81dc1fad6ff5deeed18a41bf6fe14f00"]}
  {:id "http://localhost:3000/ctia/relationship/relationship-eca9e3c6-1c32-484e-b8a5-685719142090"
   :created "2021-07-05T09:52:39.743Z"
   :owner "gereteo"
   :groups "ireaux"
   :type "relationship",
   :source "Modeling Incidents in CTIM Tutorial",
   :source_uri "https://github.com/threatgrid/ctim/blob/master/src/doc/tutorials/modeling-incidents-in-ctim.md",
   :source_ref "transient:ctim-tutorial-sighting-7b36e0fa2169a3ca330c7790f63c97fd3c9f482f88ee1b350511d8a51fcecc8d",
   :target_ref "https://ex.tld/ctia/indicator/indicator-b790ade3-e45e-48d4-7d06-f0079e6453a0",
   :description "Sighting of host communication with known Emotet Epoch 2 C&C server",
   :relationship_type "sighting-of",
   :external_ids ["ctim-tutorial-relationship-f879541251b139dfbfbed0f5c66a7c6d20246074241fa2f814f0f3eb2250def8"]}]}
#+end_src

** delete

#+begin_src clojure
(s/defschema NewBulkDelete
   (st/optional-keys
    {:actors           [Reference]
     :assets           [Reference]
     :asset_mappings   [Reference]
     :asset_properties [Reference]
     :attack_patterns  [Reference]
     :campaigns        [Reference]
     :coas             [Reference]
     :incidents        [Reference]
     :indicators       [Reference]
     :investigations   [Reference]
     :judgements       [Reference]
     :malwares         [Reference]
     :relationships    [Reference]
     :casebooks        [Reference]
     :sightings        [Reference]
     :target_records   [Reference]
     :tools            [Reference]
     :vulnerabilities  [Reference]
     :weaknesses       [Reference]}))
#+end_src

#+begin_src clojure
(s/defschema BulkErrors
  (st/optional-keys
   {:not-found [Reference]
    :forbidden [Reference]
    :internal-error [Reference]}))

(s/defschema BulkActions
  (st/optional-keys
   {:deleted [Reference]
    :updated [Reference]
    :errors BulkErrors}))

(s/defschema BulkDeleteRes
   (st/optional-keys
    {:actors           BulkAction
     :assets           BulkAction
     :asset_mappings   BulkAction
     :asset_properties BulkAction
     :attack_patterns  BulkAction
     :campaigns        BulkAction
     :coas             BulkAction
     :incidents        BulkAction
     :indicators       BulkAction
     :investigations   BulkAction
     :judgements       BulkAction
     :malwares         BulkAction
     :relationships    BulkAction
     :casebooks        BulkAction
     :sightings        BulkAction
     :target_records   BulkAction
     :tools            BulkAction
     :vulnerabilities  BulkAction
     :weaknesses       BulkAction}))
#+end_src

example:
#+begin_src clojure
{:incidents ["http://localhost:3000/ctia/incident/incident-36c956ee-fde8-4e84-8396-7be9201a9c55"],
 :sightings ["http://localhost:3000/ctia/sighting/sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27"],
 :relationships ["http://localhost:3000/ctia/relationship/relationship-94b5d199-6353-490d-9b75-38bef7f2dc5a" "http://localhost:3000/ctia/relationship/relationship-eca9e3c6-1c32-484e-b8a5-685719142090"]}
#+end_src

returns
#+begin_src clojure
{:incidents
 {:deleted
  ["http://localhost:3000/ctia/incident/incident-36c956ee-fde8-4e84-8396-7be9201a9c55"]}
 :sightings
 {:deleted
  ["http://localhost:3000/ctia/sighting/sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27"]},
 :relationships
 {:deleted
  ["http://localhost:3000/ctia/relationship/relationship-94b5d199-6353-490d-9b75-38bef7f2dc5a" "http://localhost:3000/ctia/relationship/relationship-eca9e3c6-1c32-484e-b8a5-685719142090"]}}
#+end_src

Errors are handled per entities. If an entitiy is not visible to a user or does not exist, its id will be indicated as not found. If the user can read the entity but not delete it (ex: tlp green and max-record-visibility set to "everyone"), its id will be indicated as not found.
The example below shows a response with a mix of not-found, forbidden and deleted entities:
#+begin_src clojure
{:incidents
 {:errors
  {:not-found
   ["http://localhost:3000/ctia/incident/incident-36c956ee-fde8-4e84-8396-7be9201a9c55"]}}
 :sightings
 {:deleted
  ["http://localhost:3000/ctia/incident/sighting-48c057ee-fde9-8e94-8396-5be3261a7c44"]
  :errors
  {:not-found
   ["http://localhost:3000/ctia/sighting/sighting-13cb98d6-123e-2b3c-0b8b-cddc4fb3ce57"]
   :forbidden
   ["http://localhost:3000/ctia/sighting/sighting-68cb80d5-826e-4b5c-9b9b-cddc5fb1ce27"]}},
 :relationships
 {:deleted
  ["http://localhost:3000/ctia/relationship/relationship-94b5d199-6353-490d-9b75-38bef7f2dc5a" "http://localhost:3000/ctia/relationship/relationship-eca9e3c6-1c32-484e-b8a5-685719142090"]}}
#+end_src
